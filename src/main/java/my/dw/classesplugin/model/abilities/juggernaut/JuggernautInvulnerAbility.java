package my.dw.classesplugin.model.abilities.juggernaut;

import my.dw.classesplugin.model.abilities.ActiveAbility;
import my.dw.classesplugin.utils.Constants;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;

import java.time.Instant;
import java.util.List;
import java.util.Objects;

import static my.dw.classesplugin.utils.AbilityUtils.generateItemMetaTrigger;
import static org.bukkit.attribute.Attribute.GENERIC_MAX_HEALTH;

public class JuggernautInvulnerAbility extends ActiveAbility {

    private final PotionEffect effect;

    public JuggernautInvulnerAbility() {
        super(
            "Immovable Object",
            generateItemMetaTrigger(
                Material.INK_SAC,
                "Immovable Object",
                List.of(
                    "Requires 30% Max HP to activate.",
                    "Sacrifice 50% Current HP; Grants invulnerability for 10s",
                    "Cooldown: 30s"
                )
            ),
            10,
            30
        );
        this.effect = new PotionEffect(PotionEffectType.RESISTANCE, getDuration() * Constants.TICKS_PER_SECOND, 4);
    }

    @Override
    public void handleAbility(final Player player, ItemStack itemTrigger) {
        if (Objects.isNull(player.getAttribute(GENERIC_MAX_HEALTH))
            || player.getHealth() < (player.getAttribute(GENERIC_MAX_HEALTH).getValue() * 0.3)) {
            player.sendMessage("You need at least 30% Max HP to activate this ability");
            return;
        }

        player.setHealth(player.getHealth() / 2);
        player.sendHurtAnimation(0);
        player.addPotionEffect(effect);
        setLastAbilityInstant(player.getUniqueId(), Instant.now());
    }

}
